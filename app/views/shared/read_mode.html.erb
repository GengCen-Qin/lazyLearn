<% # 通用 read_mode 页面，支持视频和音频 %>

<% # 确定当前资源类型和对象 %>
<% if controller_name == 'videos' %>
  <% content_for :title, "#{@video.title} - Read Mode" %>
  <% resource = @video %>
  <% resource_type = 'video' %>
  <% back_path = video_path(resource) %>
<% else %>
  <% content_for :title, "#{@audio.title} - Read Mode" %>
  <% resource = @audio %>
  <% resource_type = 'audio' %>
  <% back_path = audio_path(resource) %>
<% end %>

<%= stylesheet_link_tag "word_lookup", "data-turbo-track": "reload" %>

<div class="min-h-screen dark:bg-gray-900">
  <!-- 头部 -->
  <header class="dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
    <div class="max-w-4xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-2 flex-1 min-w-0">
          <%= link_to back_path,
              class: "flex items-center gap-1 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 flex-shrink-0" do %>
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            <span class="text-sm font-medium">Back</span>
          <% end %>

          <span class="text-gray-300 dark:text-gray-600">|</span>

          <h1 class="text-base font-semibold text-gray-800 dark:text-gray-100 truncate">
            <%= resource.title %>
          </h1>
        </div>

        <div class="text-sm text-gray-600 dark:text-gray-300">
          <%= resource.transcription_segments.size %> subtitles
        </div>
      </div>
    </div>
  </header>

  <!-- 内容区域 -->
  <main class="max-w-4xl mx-auto px-4 py-6">
    <div id="read-mode-content"
         class="read-mode-subtitle-list"
         data-controller="video--read-mode text-selection-explain"
         data-video--read-mode-<%= resource_type %>-id-value="<%= resource.id %>">
      <% if resource.has_transcription? %>
        <% resource.formatted_transcription.each do |segment| %>
          <div class="my-3 mx-3">
            <div class="text-base leading-relaxed text-gray-800 dark:text-gray-200">
              <%= render_text_with_clickable_words(segment[:text]) %>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="text-center text-gray-500 dark:text-gray-400 p-8">
          No subtitles available
        </div>
      <% end %>
    </div>
  </main>
</div>
