// xgplayer-subtitles@3.0.23 downloaded from https://ga.jspm.io/npm:xgplayer-subtitles@3.0.23/es/index.js

import e from"eventemitter3";function t(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function r(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?t(Object(n),true).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):t(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||false;n.configurable=true;"value"in n&&(n.writable=true);Object.defineProperty(e,m(n.key),n)}}function s(e,t,r){t&&a(e.prototype,t);r&&a(e,r);Object.defineProperty(e,"prototype",{writable:false});return e}function o(e,t,r){t=m(t);t in e?Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true}):e[t]=r;return e}function l(e,t){if(typeof t!=="function"&&t!==null)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});Object.defineProperty(e,"prototype",{writable:false});t&&c(e,t)}function u(e){u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)};return u(e)}function c(e,t){c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){e.__proto__=t;return e};return c(e,t)}function h(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})));return true}catch(e){return false}}function f(e){if(e===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function v(e,t){if(t&&(typeof t==="object"||typeof t==="function"))return t;if(t!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return f(e)}function d(e){var t=h();return function(){var r,n=u(e);if(t){var i=u(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return v(this,r)}}function p(e,t){while(!Object.prototype.hasOwnProperty.call(e,t)){e=u(e);if(e===null)break}return e}function g(){g=typeof Reflect!=="undefined"&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=p(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}};return g.apply(this,arguments)}function y(e,t){if(typeof e!=="object"||e===null)return e;var r=e[Symbol.toPrimitive];if(r!==void 0){var n=r.call(e,t||"default");if(typeof n!=="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function m(e){var t=y(e,"string");return typeof t==="symbol"?t:String(t)}var _=/^WEBVTT/i;var T=/^STYLE+$/;var b=/^\:\:cue/;var x=/^}+$/;var k=/^\[Script Info\].*/;var w=[/[0-9]{1,3}:[0-9]{2}:[0-9]{2}\.[0-9]{1,3}-->[0-9]{1,3}:[0-9]{2}:[0-9]{2}\.[0-9]{1,3}/,/[0-9]{1,3}:[0-9]{2}\.[0-9]{1,3}-->[0-9]{1,3}:[0-9]{2}\.[0-9]{1,3}/,/[0-9]{1,2}\.[0-9]{1,3}-->[0-9]{1,2}\.[0-9]{1,3}/];var O=50;var S=/^Format:\s/;var R=/^Style:\s/;var E=/^Dialogue:\s/;function P(e){var t=e.length;return t===3?((Number(e[0])*60+Number(e[1]))*60*1e3+Number(e[2])*1e3)/1e3:t===2?(Number(e[0])*60*1e3+Number(e[1])*1e3)/1e3:Number(e[0])}function j(e){return/^(\-|\+)?\d+(\.\d+)?$/.test(e)}function A(e){return e}function C(e,t){return e>=0&&e<t.length?t[e]:""}var I=function(){function e(){i(this,e)}s(e,null,[{key:"parseJson",value:function(e){var t=[];var r=0;for(var n=0;n<e.length;n++){r>=O&&(r=0);if(r===0){var i={start:e[n].start,list:[e[n]],end:e[n].end};t.push(i)}else{t[t.length-1].list.push(e[n]);t[t.length-1].end=e[n].end}r++}return t}},{key:"parse",value:function(t,r){var n=e.checkFormat(t);n||r({format:n});try{var i=[];n==="ass"?i=e.parseASS(t):n==="vtt"&&(i=e.parseVTT(t));r({format:n,list:i.list,styles:i.styles})}catch(e){console.error(e);r({format:n},e)}}},{key:"parseASSItem",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"";var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];var r=e.split(",");var n={};var i="";try{var a=r.length-t.length;i=a>0?r.splice(t.length-1,a+1).join(",")+"":r[r.length-1]+"";i=i.replace(/\\n+/g,"");i=A(i);r[t.length-1]=i;t.map((function(e,t){if(e==="end"||e==="start")n[e]=P(r[t].split(":"));else if(e==="text")n[e]=[r[t]];else if(e==="layer"){n[e]=[r[t]];n.textTag=[r[t]]}else n[e]=e==="style"?[r[t]]:Number(r[t])?Number(r[t]):r[t]}));return n}catch(e){console.error(e);return{}}}},{key:"parseASS",value:function(t){var r=t.split("\n");var n=[];var i=0;var a=0;var s=[];var o=[];var l=null;while(i<r.length){if(S.test(r[i])){o=r[i].replace(S,"").replace(/\s+/g,"").split(",");o=o.map((function(e){return e.toLocaleLowerCase()}))}else if(R.test(r[i]))s.push(r[i].replace(R,"").replace(/\s+/g,""));else if(E.test(r[i])){var u=e.parseASSItem(r[i].replace(E,""),o);if(l&&(u.start===l.start&&u.end===l.end))try{var c=l,h=c.text,f=c.textTag,v=c.style;h.push(u.text[0]);f.push(u.textTag[0]);v.push(u.style[0])}catch(e){console.error(e)}else{l=u;var d=null;if(a%O===0){d={start:l.start,end:l.end,list:[]};d.list.push(l);n.push(d)}else{d=n[n.length-1];d.end=l.end;d.list.push(l)}a++}}i++}return{list:n,style:{}}}},{key:"parseVTTStyle",value:function(e,t){var r=e.split(":");if(r.length>1){var n=r[0].trim().split("-");var i="";n.length>1?n.map((function(e,t){i+=t===0?e:e.charAt(0).toUpperCase()+e.slice(1)})):i=n[0];t[i]=r[1].trim().replace(/;$/,"")}return t}},{key:"parseVTT",value:function(e){e=e.replace(_,"");var t=e.split("\n");var r=[];var n=0;var i=0;var a=null;var s=false;var o=false;var l=null;var u=null;var c=[];while(n<t.length){var h=C(n,t).trim();if(!h||s&&j(h))s=!h;else if(b.test(h)&&T.test(C(n-1,t).trim())){o=true;var f=/\((.+?)\)/g.exec(h);u=f?f[1]:"";l=""}else if(o)if(x.test(h)){c.push({key:u,style:l});l=null;u=null;o=false}else l+=h;else if(h){s=false;var v=this.checkIsTime(t[n]);if(v){var d=this.parseVttTime(v);if(!a||!(d.start===a.start&&d.end===a.end)){a=d;a.text=[];a.textTag=[];var p=null;if(i%O===0){p={start:a.start,end:a.end,list:[]};p.list.push(a);r.push(p)}else{p=r[r.length-1];p.end=a.end;p.list.push(a)}i++}}else if(a){var g=a,y=g.text,m=g.textTag;var k=this.parseVttText(t[n]);y.push(k.text);m.push(k.tag)}s=false}n++}return{list:r,styles:c}}},{key:"checkIsTime",value:function(e){e=e.replace(/\s+/g,"");var t=0;var r=null;while(t<w.length){r=w[t].exec(e);if(r)break;t++}return r?r[0]:null}},{key:"parseVttText",value:function(e){var t=/^(<?.+?>)/g.exec(e);var r="";var n="default";if(t){n=t[0].replace(/\<|\>|\&/g,"");var i=RegExp("^<".concat(n,">(([\\s\\S])*?)</").concat(n,">$"));var a=i.exec(e);if(a)r=a[1];else{r=e;n=""}}else r=e;var s=/<(\w+).(\w+)>/g;var o=s.exec(r);while(o&&o.length>2){r=r.replace(o[0],"<".concat(o[1],' class="').concat(o[2],'">'));o=s.exec(r)}return{tag:n,text:A(r.replace(/\\n+/g,"<br/>"))}}},{key:"parseVttTime",value:function(e){var t=e.split("--\x3e");var r;var n=0;if(t.length===2){var i=t[0].split(":");var a=t[1].split(":");r=P(i);n=P(a)}return{start:r,end:n,time:e}}},{key:"isVTT",value:function(e){return _.test(e)}},{key:"isASS",value:function(e){return k.test(e)}},{key:"checkFormat",value:function(e){return e?_.test(e)?"vtt":k.test(e)?"ass":null:null}}]);return e}();var N=[{code:0,msg:"SUCCESS"},{code:1,msg:"LOAD_ERROR"},{code:2,msg:"PARSER_ERROR"},{code:3,msg:"FORMAT_NOT_SUPPORTED"},{code:4,msg:"ID_OR_LANGUAGE_NOT_EXIST"},{code:5,msg:"PARAMETERS_ERROR"},{code:6,msg:"ABORT"},{code:7,msg:"UNKNOWN"},{code:8,msg:"DATA_ERROR:subtitle.url is null"},{code:9,msg:"DATA_ERROR:subtitle.url length is 0"}];function M(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var r={code:N[e].code,msg:N[e].msg};Object.keys(t).map((function(e){r[e]=t[e]}));return r}var B=s((function e(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},r=t.url,n=t.method,a=n===void 0?"GET":n,s=t.type,o=s===void 0?"arraybuffer":s,l=t.timeout,u=l===void 0?1e4:l,c=t.data,h=c===void 0?{}:c;var f=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};i(this,e);return new Promise((function(e,t){var n=new window.XMLHttpRequest;var i=a.toUpperCase();var s=[];o&&(n.responseType=o);u&&(n.timeout=u);Object.keys(h).forEach((function(e){s.push("k=".concat(h[e]))}));n.onload=function(){n.status===200||n.status===206?e({context:f,res:n}):t(new Error({context:f,res:n,type:"error"}))};n.onerror=function(e){t(new Error({context:f,res:n,type:"error"}))};n.ontimeout=function(e){t(new Error({context:f,res:n,type:"error"}))};n.onabort=function(){t(new Error({context:f,res:n,type:"error"}))};if(i==="GET"){n.open(i,"".concat(r));n.send()}else{if(i!=="post")throw new Error("xhr ".concat(i," is not supported"));n.open(i,r);n.setRequestHeader("Content-type","application/x-www-form-urlencoded");n.send(s.join("&"))}}))}));var L=function(){function e(){i(this,e);var t;var r;var n=new Promise((function(e,n){t=e;r=n}));var a=n;a.resolve=function(e){t(e);a.state="fulfilled"};a.reject=function(e){r(e);a.state="rejected";a.isBreak=e==="DESTROYED"};a.state="pending";return a}s(e,[{key:"resolve",value:function(e){}},{key:"reject",value:function(e){}}]);return e}();function z(e,t){if(!e)return false;if(e.classList)return Array.prototype.some.call(e.classList,(function(e){return e===t}));var r=e.className&&n(e.className)==="object"?e.getAttribute("class"):e.className;return r&&!!r.match(new RegExp("(\\s|^)"+t+"(\\s|$)"))}function D(e,t){e&&(e.classList?t.replace(/(^\s+|\s+$)/g,"").split(/\s+/g).forEach((function(t){t&&e.classList.add(t)})):z(e,t)||(e.className&&n(e.className)==="object"?e.setAttribute("class",e.getAttribute("class")+" "+t):e.className+=" "+t))}function U(e,t){e&&(e.classList?t.split(/\s+/g).forEach((function(t){e.classList.remove(t)})):z(e,t)&&t.split(/\s+/g).forEach((function(t){var r=new RegExp("(\\s|^)"+t+"(\\s|$)");e.className&&n(e.className)==="object"?e.setAttribute("class",e.getAttribute("class").replace(r," ")):e.className=e.className.replace(r," ")})))}function H(e,t,r){var n=t.length;if(n<1)return-1;r=r<0?0:r>=n?n-1:r;if(t[r].start<=e&&e<t[r].end)return r;var i=t[r].end<=e?r+1:0;for(;i<n;i++){if(t[i].start<=e&&e<t[i].end)return i;if(e>t[i].end&&i+1<n&&e<t[i+1].start)return-1;if(e>t[i].end&&i+1>=n)return-1}return-1}function W(e,t,r){var n=t.length;if(n<1)return[];r=r<0?0:r>=n?n-1:r;var i=[];if(r<n){var a=t[r].end<=e?r:0;for(;a<n;a++){t[a].start<=e&&e<t[a].end&&i.push(a);if(e<t[a].start)break}}return i}function F(e,t,r){if(e.length===0||t<0||t>e.length-1)return[];var n=e[t].list;if(r.length===0)return[];var i=n.splice(r[0],r.length);t>0&&e.splice(0,t);n.length===0&&e.splice(0,1);return i}function V(e){return Object.prototype.toString.call(e).match(/([^\s.*]+)(?=]$)/g)[0]}function $(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"div";var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"";var i=document.createElement(e);i.className=n;i.innerHTML=t;Object.keys(r).forEach((function(t){var n=t;var a=r[t];e==="video"||e==="audio"||e==="live-video"?a&&i.setAttribute(n,a):i.setAttribute(n,a)}));return i}function G(){var e=navigator.userAgent;var t=/(?:Windows Phone)/.test(e);var r=/(?:SymbianOS)/.test(e)||t;var n=/(?:Android)/.test(e);var i=/(?:Firefox)/.test(e);var a=/(?:iPad|PlayBook)/.test(e)||n&&!/(?:Mobile)/.test(e)||i&&/(?:Tablet)/.test(e);var s=/(?:iPhone)/.test(e)&&!a;return s||n||r||a}function X(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"";var r="";e.map((function(e){r+=" ".concat(t," ").concat(e.key," {").concat(e.style,"}")}));var n=document.createElement("style");var i=document.head||document.getElementsByTagName("head")[0];n.type="text/css";n.id="ssss";if(n.styleSheet){var a=function(){try{n.styleSheet.cssText=r}catch(e){}};n.styleSheet.disabled?setTimeout(a,10):a()}else{var s=document.createTextNode(r);n.appendChild(s)}i.appendChild(n)}function Y(e,t,r){r||(r=new L);if(t==="json"){var n=I.parseJson(e);r.resolve({list:n,format:"json"})}else t==="string"&&I.parse(e,(function(e,t){if(t){var n=M(2,t);r.reject(n,{format:e.format})}else if(e.format)r.resolve({styles:e.styles,list:e.list,format:e.format});else{var i=M(3);r.reject(i)}}));return r}function q(e,t){t||(t=new L);new B({url:e.url,type:"text"}).then((function(n){Y(n.res.response,"string").then((function(n){t.resolve(r(r({},n),e))})).catch((function(e){t.reject(e)}))})).catch((function(n){var i=M(1,r({statusText:n.statusText,status:n.status,type:n.type,message:"http load error",url:e.src},e));t.reject(i)}));return t}function Z(e,t){return!!(e.id&&t.id&&e.id===t.id||e.language&&t.language&&e.language===t.language)}function J(e){return e!==null&&e.trim()!==""&&/^[a-zA-Z]+$/.test(e)}function K(e){var t=/[\x21-\x2f\x3a-\x40\x5b-\x60\x7B-\x7F]/;return!!t.test(e)}function Q(e){var t=/[\u3002|\uff1f|\uff01|\uff0c|\u3001|\uff1b|\uff1a|\u201c|\u201d|\u2018|\u2019|\uff08|\uff09|\u300a|\u300b|\u3008|\u3009|\u3010|\u3011|\u300e|\u300f|\u300c|\u300d|\ufe43|\ufe44|\u3014|\u3015|\u2026|\u2014|\uff5e|\ufe4f|\uffe5]/;return!!t.test(e)}function ee(e){var t=e.split("");var r=[];var n=false;for(var i=0;i<t.length;i++){var a=t[i];if(J(a))if(n){var s=r.length-1;r[s]="".concat(r[s]).concat(a)}else{r.push(a);n=true}else if(a.match(/^[ ]*$/)||K(a)||Q(a)){n=false;var o=r.length-1;r[o]="".concat(r[o]).concat(a)}else{n=false;r.push(a)}}return r}var te=function(){function e(){var t=this;i(this,e);this.__handlers=[];window.ResizeObserver&&(this.observer=new window.ResizeObserver((function(e){t.__trigger(e)})))}s(e,[{key:"addObserver",value:function(e,t){if(this.observer){this.observer&&this.observer.observe(e);var r=this.__handlers;var n=-1;for(var i=0;i<r.length;i++)r[i]&&e===r[i].target&&(n=i);n>-1?this.__handlers[n].handler.push(t):this.__handlers.push({target:e,handler:[t]})}}},{key:"unObserver",value:function(e){var t=-1;this.__handlers.map((function(r,n){e===r.target&&(t=n)}));this.observer&&this.observer.unobserve(e);t>-1&&this.__handlers.splice(t,1)}},{key:"destroyObserver",value:function(){this.observer&&this.observer.disconnect();this.observer=null;this.__handlers=null}},{key:"__runHandler",value:function(e,t){var r=this.__handlers;for(var n=0;n<r.length;n++)if(r[n]&&e===r[n].target){r[n].handler&&r[n].handler.forEach((function(r){try{r(e,t)}catch(e){console.error(e)}}));break}}},{key:"__trigger",value:function(e){var t=this;e.map((function(e){var r=e.contentRect;t.__runHandler(e.target,r)}))}}]);return e}();var re=null;function ne(e,t){re||(re=new te);re.addObserver(e,t)}function ie(e,t){re&&re.unObserver(e,t)}var ae={RESIZE:"resize",CHANGE:"change",OFF:"off",UPDATE:"update"};function se(e){var t=[];e&&V(e)==="String"?t.push({url:e,index:0,start:-1,end:-1}):V(e)==="Array"&&e.forEach((function(e,r){t.push({url:e.url||e.src,index:r,start:e.start||-1,end:e.end||-1})}));return t}var oe=false;var le=function(e){l(n,e);var t=d(n);function n(e){var r;i(this,n);r=t.call(this);o(f(r),"_onPause",(function(){r.stopRender()}));o(f(r),"_onPlay",(function(){r._curRenderTask.length>0&&r.startRender(-1)}));o(f(r),"_onTimeupdate",(function(){if(r._isOpen){var e=r.player.video,t=e.videoWidth,n=e.videoHeight;!r._videoMeta.scale&&t&&n&&r._onResize(r.player.root);var i=r._getPlayerCurrentTime();if(!(Math.round(Math.abs(i*1e3-r._ctime))<200)){r._ctime=i*1e3;r.currentText&&r.currentText.list&&(r.config.updateMode==="live"?r._liveUpdate(i):r._update(i))}}}));o(f(r),"_onResize",(function(e){var t=f(r),n=t._videoMeta,i=t.config;if(i.domRender){e&&e instanceof window.Element||(e=r.player.root);if(r._iId){clearTimeout(r._iId);r._iId=null}if(!n.scale){if(!r.player.video)return;var a=r.player.video,s=a.videoWidth,o=a.videoHeight;if(!s||!o)return;n.videoWidth=s;n.videoHeight=o;n.scale=parseInt(o/s*100,10)}r.__startResize(e)}}));o(f(r),"_onCoreEvents",(function(e){try{switch(e.eventName){case"core.subtitlesegments":r._onSubtitleSegment(e.list||[]);break;case"core.subtitleplaylist":r._onSubtitlePlaylist(e.list||[]);break;case"core.seipayloadtime":r._onCoreSeiintime(e);break;default:}}catch(e){console.error(e)}}));o(f(r),"startRender",(function(e){if(e>0&&r._renderIntervalId){window.cancelAnimationFrame(r._renderIntervalId);r._renderIntervalId=-1}if(r.textTrack){var t=f(r),n=t._curRenderTask;r._lastTimeStamp=(new Date).getTime();var i=[];n.forEach((function(t,n){var a=t.lastTime,s=t.wordList,o=t.interval,l=t.dom,u=t.ids;if(e<0||r._lastTimeStamp<0||r._lastTimeStamp-a>=o){var c=s.shift();c&&l.appendData(c);t.lastTime=r._lastTimeStamp}s.length<1&&i.push({index:n,ids:u})}));r._log(">>>>_renderByWords emptyArr",i.length,n.length);i.forEach((function(e){n.splice(e.index,1);r._log(">>>_renderByWords remove emptyArr",e.index,n.length)}));n.length>0&&(r._renderIntervalId=window.requestAnimationFrame(r.startRender))}}));o(f(r),"destroy",(function(){r.detachPlayer();r.removeAllListeners();r.player=null;r.textTrack=null;r._curRenderTask=[];r.stopRender()}));oe=G();r.currentText=null;r.currentExtText=null;r.textTrack=[];r._cid=-1;r._gid=-1;r._cids=[];r._iId=null;r._iC=0;r.player=null;r.root=null;r.config={line:"double",bottom:0,mode:"stroke",defaultOpen:false,baseSizeX:49,baseSizeY:28,minSize:16,minMobileSize:13,fitVideo:true,offsetBottom:2,fontColor:"#fff",domRender:true,updateMode:"vod",renderMode:"",debugger:false};r._ctime=0;r._loadingTrack={};Object.keys(r.config).map((function(t){e[t]!==void 0&&e[t]!==null&&(r.config[t]=e[t])}));r._isOpen=r.config.defaultOpen||false;r._videoMeta={scale:0,videoHeight:0,videoWidth:0,lwidth:0,lheight:0,vWidth:0,vHeight:0,vBottom:0,vLeft:0,marginBottom:0};if(!e.subTitles||V(e.subTitles)!=="Array")return v(r);e.player&&r.attachPlayer(e.player);r.seiTime=0;r.lastSeiTime=0;r._curTexts=[];r._curRenderTask=[];r._renderIntervalId=-1;r._lastTimeStamp=-1;r.setSubTitles(e.subTitles,r.config.defaultOpen);return r}s(n,[{key:"version",get:function(){return"3.0.23"}},{key:"setSubTitles",value:function(){var e=this;var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];var r=arguments.length>1&&arguments[1]!==void 0&&arguments[1];var n=!(arguments.length>2&&arguments[2]!==void 0)||arguments[2];var i=this._isOpen||r;n&&this.innerRoot&&this.switchOff();this.currentText=null;this.textTrack=[];t.forEach((function(t){var r={};Object.keys(t).map((function(e){r[e]=t[e]}));r.url=se(r.url);r.isDefault&&(e.currentText=r);e.textTrack.push(r)}));this._log("setSubTitles",i);i&&this.switch().catch((function(t){e._log("[switch]",t)}));this.currentText&&this._loadTrack(this.currentText).then((function(t){e.addStyles(t)}));this.emit("reset",{list:this.textTrack,isOpen:i})}},{key:"updateSubTitle",value:function(e){var t=this;var r=-1;for(var n=0;n<this.textTrack.length;n++)if(Z(e,this.textTrack[n])){r=n;break}this._log("updateSubTitle",r,e);if(r>-1){var i=Z(this.currentText,this.textTrack[r]);this._log("updateSubTitle","_isCurrent",i,"this.isOpen",this.isOpen,this.currentText);if(!i)return;var a=se(e.url);if(this.isOpen){a.forEach((function(e){t.textTrack[r].url.push(e)}));this._log("updateSubTitle _loadTrackUrls",this.textTrack[r]);this._loadTrackUrls(this.currentText,2)}else this.textTrack[r].url=a}}},{key:"addStyles",value:function(e){var t=e.styles,r=e.format;if(t&&r==="vtt"){t.map((function(e){e.key||(e.key="xg-text-track-span")}));X(t,"xg-text-track")}}},{key:"attachPlayer",value:function(e){var t=this;this._log("attachPlayer");if(e){this.player&&this.detachPlayer();var r=this.config,n=r.fontColor,i=r.mode,a=r.fitVideo,s=r.domRender;this.player=e;if(s){this.root=document.createElement("xg-text-track");this.root.className="xg-text-track";!this._isOpen&&D(this.root,"text-track-hide");!a&&D(this.root,"text-track-no-fitvideo");i&&D(this.root,"text-track-".concat(i));this.innerRoot=document.createElement("xg-text-track-inner");this.root.appendChild(this.innerRoot);n&&(this.root.style.color=n);this.currentText&&["language","id","label"].map((function(e){t.root.setAttribute("data-".concat(e),t.currentText[e]||"")}));this.player.root.appendChild(this.root);ne(e.root,this._onResize)}this.player.on("destroy",this.destroy);this.player.on("timeupdate",this._onTimeupdate);this.player.on("pause",this._onPause);this.player.on("play",this._onPlay);this.player.on("core_event",this._onCoreEvents);this._isOpen&&this.switch().catch((function(e){t._log("[switch]",e)}))}}},{key:"detachPlayer",value:function(){var e=this.player,t=this.config;if(e){e.off("destroy",this.destroy);e.off("timeupdate",this._onTimeupdate);e.off("pause",this._onPause);e.off("play",this._onPlay);e.off("core_event",this._onCoreEvents);if(t.domRender){if(e.root){ie(e.root,this._onResize);e.root.removeChild(this.root)}this.innerRoot=null;this.root=null}this.player=null}}},{key:"switch",value:function(){var e=this;var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:"",language:""};this._log("switch",t);this._loadingTrack=t;return new Promise((function(r,n){if(t.id||t.language)if(e.currentText&&Z(t,e.currentText)){e._loadingTrack={};e._updateCurrent(e.currentText);e.switchOn();r(M(0))}else{var i=null;e.__removeByTime(e._curTexts,0);for(var a=0;a<e.textTrack.length;a++)if(Z(t,e.textTrack[a])){i=e.textTrack[a];break}e._log("nextSubtitle",i);if(i){e._emitPlayerSwitch(e.currentText,i);if(i.list){e._loadingTrack={};e._updateCurrent(i);e.switchOn();r(M(0))}else{e._log("this._loadTrack",i);e._updateCurrent(i);e._loadTrack(i).then((function(t){e.addStyles(t);if(e._loadingTrack.id===i.id||e._loadingTrack.language===t.language){e._loadingTrack={};e._updateCurrent(t);e.switchOn();r(M(0))}else{var a=M(6,{message:"check _loadingTrack fail id: ".concat(e._loadingTrack.id,"  nextSubtitle:").concat(t.id)});n(a)}})).catch((function(e){n(e)}))}}else{var s=M(4,new Error("The is no subtitle with id:[{".concat(t.id,"}] or language:[").concat(t.language,"]")));n(s)}}else{if(e.currentText){e._loadingTrack={};e._updateCurrent(e.currentText);e.switchOn();var o=M(0,{message:"switch default subtitle success"});r(o);return}var l=M(5,{message:"no default subtitle"});n(l)}}))}},{key:"switchExt",value:function(){var e=this;var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{id:"",language:""};return new Promise((function(r,n){if(t.id||t.language){var i=null;for(var a=0;a<e.textTrack.length;a++)if(Z(t,e.textTrack[a])){i=e.textTrack[a];break}i&&!Z(i,e.currentText)&&e._loadTrack(i).then((function(t){e.currentExtText=t;r(M(0))}))}else{e.currentExtText=null;r(M(0))}}))}},{key:"switchOn",value:function(){this._log("switchOn");this._isOpen=true;this.show();this.emit(ae.CHANGE,this.currentText)}},{key:"switchOff",value:function(){this._isOpen=false;this.hide();this.emit(ae.OFF)}},{key:"isOpen",get:function(){return this._isOpen}},{key:"_log",value:function(){if(this.config.debugger){var e;for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];(e=console).log.apply(e,["[xgSubtitle]"].concat(r))}}},{key:"_loadTrack",value:function(e){var t=this;this._log("_loadTrack",e.language,e);var r=new L;var n="";var i="";if(e.json){n="json";i=e.json}else if(e.stringContent&&!e.url){n="string";i=e.stringContent}if(i){Y(i,n).then((function(t){e.format=t.format;e.styles=t.styles;e.list=t.list;r.resolve(e)})).catch((function(e){r.reject(e)}));return r}var a=e.url;if(a.length===0){r.resolve(e);return r}var s=a.splice(0,1);q(s[0]).then((function(n){e.format=n.format;e.styles=n.styles;e.list||(e.list=[]);t._pushList(e.list,n.list);a.length>1&&t._loadTrackUrls(e,2);r.resolve(e)})).catch((function(e){r.reject(e)}));return r}},{key:"_emitPlayerSwitch",value:function(e,t){if(e&&this.config.updateMode==="live"){e.list=[];e.url=[]}var n=r({lang:t.language},t);this._log("emit subtile_switch ",t,n);this.player&&this.player.emit("switch_subtitle",n)}},{key:"_loadTrackUrls",value:function(e,t,n){var i=this;var a=e.url.length;var s=a>t?e.url.splice(0,t):e.url.splice(0,a);var o=s.length;this._log("_loadTrackUrls",e.language,a,s.length,o);s.forEach((function(t,a){var s=r(r({},t),{},{index:a});q(s).then((function(t){e.format=t.format;e.styles=t.format;e.list||(e.list=[]);i._pushList(e.list,t.list);o--})).catch((function(e){o--})).finally((function(t){if(o===0){n&&n.resolve(e);i._loadTrackUrls(e,2)}}))}))}},{key:"_freshUrl",value:function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{url:""};var r=-1;e.url.forEach((function(e,n){e.url===t.url&&(r=n)}));r>-1&&e.url.splice(r,1)}},{key:"_pushList",value:function(e,t){var r=t[0].start;var n=t[t.length-1].end;if(e.length===0||r>=e[e.length-1].end)t.forEach((function(t){e.push(t)}));else{var i=-1;for(var a=0;a<e.length;a++)if(e[a].start>n){i=a;break}i>-1&&t.forEach((function(t,r){e.splice(i+r,0,t)}))}return e}},{key:"_updateCurrent",value:function(e){var t=this;this.currentText=e;if(this.config.domRender&&this.root){["language","id","label"].map((function(e){t.root.setAttribute("data-".concat(e),t.currentText[e]||"")}));this.__remove(this._cids)}this._cids=[];this._gid=-1;this._cid=-1;this._curTexts=[];var r=this._getPlayerCurrentTime();r&&(this.config.updateMode==="live"?this._liveUpdate(r):this._update(r))}},{key:"__loadAll",value:function(){var e=this;this.textTrack.forEach((function(t){e._loadTrack(t)}))}},{key:"getDelCid",value:function(e,t){var r=[];for(var n=0;n<e.length;n++)t.includes(e[n])||r.push(e[n]);return r}},{key:"getNewCid",value:function(e,t){var r=[];for(var n=0;n<t.length;n++)e.includes(t[n])||r.push(t[n]);return r}},{key:"_liveUpdate",value:function(e){var t=this;if(this.currentText&&this.currentText.list&&this.currentText.list.length){var r=[];var n=H(e,this.currentText.list,this._gid);n>-1&&(r=W(e,this.currentText.list[n].list,this._cid));this.__removeByTime(this._curTexts,e);this._log("_liveUpdate",e,n,r,this.currentText.list[0].list[0].start,this.currentText.list[0].list[0].end);if(r.length>0){var i=F(this.currentText.list,n,r);var a=this._curTexts.length;var s=a>0?this._curTexts[a-1].index:0;i.forEach((function(e,r){e.index=r+s;t._curTexts.push(e)}));this.__render(i)}this.emit("update",this._curTexts)}}},{key:"_update",value:function(e){var t=this;if(this.currentText&&this.currentText.list&&this.currentText.list.length){var r=H(e,this.currentText.list,this._gid);var n=[];r>-1&&(n=W(e,this.currentText.list[r].list,this._cid));if(n.length<1){this._cids.length>0&&this.config.domRender&&this.__remove(this._cids);this._cids=[]}else if(this._cids!==n||r!==this._gid){this._gid=r;this._cid=n[0];var i=this.getDelCid(this._cids,n);var a=this.getNewCid(this._cids,n);this._cids=n;this.config.domRender&&this.__remove(i);var s=[];a.map((function(e){var n=t.currentText.list[r].list[e];n.index=e;s.push(n)}));this.currentExtText&&a.map((function(e){var n=t.currentText.list[r].list[e];n.index=e;s.push(n)}));this._log("update",s,e);this.emit("update",s);this.__render(s,e)}}}},{key:"_getPlayerCurrentTime",value:function(){if(!this.player)return 0;var e=this.player.currentTime;var t=parseInt(e*1e3+this.seiTime*1e3-this.lastSeiTime*1e3,10)/1e3;return t}},{key:"_onSubtitlePlaylist",value:function(e){this._log("_onSubtitlePlaylist",e);var t=e.map((function(e){return{label:e.name,language:e.lang,id:e.id,isDefault:e.default,url:[],mUrl:e.url}}));this.setSubTitles(t)}},{key:"_onSubtitleSegment",value:function(e){this._log("_onSubtitleSegment",e.length,e[0].lang,e[0].sn,e[e.length-1].sn,e[0].start,e[e.length-1].end);if(e&&e.length!==0){var t=e[0].lang;var r=e.map((function(e){return{id:e.sn,url:e.url,duration:e.duration,start:e.start,end:e.end}}));var n={language:t,url:r};Z(n,this.currentText)&&this.updateSubTitle(n)}}},{key:"_onCoreSeiintime",value:function(e){try{var t=e.time/1e3;this._log("_onCoreSeiintime sei",t,this.seiTime,this.lastSeiTime);this.seiTime=t;this.lastSeiTime=this.player?this.player.currentTime:0}catch(e){}}},{key:"resize",value:function(e,t){var r=this;var n=this.config,i=n.baseSizeX,a=n.baseSizeY,s=n.minMobileSize,o=n.minSize,l=n.fitVideo,u=n.offsetBottom;var c=this._videoMeta.scale;this._videoMeta.lwidth=e;this._videoMeta.lheight=t;var h;var f=0;if(t/e*100>=c){f=parseInt(c*e,10)/100;h=e}else{f=t;h=parseInt(t/c*100,10)}this._videoMeta.vWidth=h;this._videoMeta.vHeight=f;var v=0;var d=0;if(c>120){v=a;d=parseInt(v*f/1080,10)}else{v=i;d=parseInt(v*h/1920,10)}var p=oe?s:o;d=d<p?p:d>v?v:d;var g={fontSize:d};var y=parseInt((t-f)/2,10);var m=parseInt((e-h)/2,10);var _=parseInt(f*u,10)/100;this._videoMeta.vBottom=y;this._videoMeta.vLeft=m;this._videoMeta.marginBottom=_;if(l){g.bottom=y+_;g.left=g.right=m}Object.keys(g).map((function(e){r.root.style[e]="".concat(g[e],"px")}));this.emit(ae.RESIZE,{vLeft:m,vBottom:y,marginBottom:_,vWidth:h,vHeight:f,fontSize:d,scale:c})}},{key:"__startResize",value:function(e){var t=this;var r=e.getBoundingClientRect();var n=this._videoMeta;var i=r.width,a=r.height;if(this._iId){clearTimeout(this._iId);this._iId=null}if(i>0&&a>0&&(i!==n.lwidth||a!==n.lheight)){this._iC=0;this.resize(i,a)}else{if(this._iC>=5){this._iC=0;return}this._iC++;this._iId=setTimeout((function(){t.__startResize(e)}),50)}}},{key:"__removeByTime",value:function(e,t){var r=[];for(var n=0;n<e.length;n++)(!t||e[n].end<t)&&r.push(n);if(r.length!==0){e.splice(r[0],r.length);this.config.domRender&&this.__remove(r)}}},{key:"__remove",value:function(e){var t=this;if(e&&!(e.length<1)){this._log(">>>>_renderByWords__remove",e);var r=this.innerRoot.children;var n=[];for(var i=0;i<r.length;i++){var a=Number(r[i].getAttribute("data-index"));e.includes(a)&&n.push(r[i])}n.map((function(e){t.innerRoot.removeChild(e)}))}}},{key:"__render",value:function(){var e=this;var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];this._log("__render",t.length,this.config.domRender);var r=this.config,n=r.renderMode,i=r.domRender;t.length>0&&i&&t.forEach((function(t){var r="text-track-".concat(e.config.line);t.text.forEach((function(i,a){a>0&&(r+=" text-track-deputy");var s={"data-start":t.start,"data-end":t.end,"data-index":t.index};var o=$("xg-text-track-span","",s,r);e.innerRoot.appendChild(o);if(n==="step"){var l=$("xg-text-track-span","",s,"".concat(r," text-track-space"));e.innerRoot.appendChild(l);l.innerHTML=i;setTimeout((function(){e._renderByWords(o,a,t.start,t.end,i)}),600)}else o.innerHTML=i}))}))}},{key:"_renderByWords",value:function(e,t,r,n,i){var a=document.createTextNode("");e.appendChild(a);var s=ee(i);var o=this._getPlayerCurrentTime();var l=parseInt(1e3*(n-o),10);if(!(o>=n)){r>=o&&(o=r);l>300&&(l-=50);var u=s.length;var c={dom:a,ids:t,wordList:s,interval:l/u,start:o,end:n,duration:l,lastTime:0};this._log(">>>>_renderByWords",l,c);var h=this._curRenderTask;var f=-1;for(var v=0;v<h.length;v++)if(h[v].ids===t){f=v;break}f>-1&&h.slice(f,1);h.push(c);this.startRender(-1)}}},{key:"stopRender",value:function(){this._renderIntervalId&&window.cancelAnimationFrame(this._renderIntervalId)}},{key:"show",value:function(){this.config.domRender&&U(this.root,"text-track-hide")}},{key:"hide",value:function(){if(this.config.domRender){D(this.root,"text-track-hide");this.innerRoot.innerHTML=""}}},{key:"emit",value:function(e,t){var r;for(var i=arguments.length,a=new Array(i>2?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];(r=g(u(n.prototype),"emit",this)).call.apply(r,[this,e,t].concat(a))}},{key:"on",value:function(e,t){var r;for(var i=arguments.length,a=new Array(i>2?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];(r=g(u(n.prototype),"on",this)).call.apply(r,[this,e,t].concat(a))}},{key:"once",value:function(e,t){var r;for(var i=arguments.length,a=new Array(i>2?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];(r=g(u(n.prototype),"once",this)).call.apply(r,[this,e,t].concat(a))}},{key:"off",value:function(e,t){var r;for(var i=arguments.length,a=new Array(i>2?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];(r=g(u(n.prototype),"off",this)).call.apply(r,[this,e,t].concat(a))}},{key:"offAll",value:function(){g(u(n.prototype),"removeAllListeners",this).call(this)}},{key:"marginBottom",get:function(){var e=this._videoMeta,t=e.bottom,r=e.marginBottom;return this.config.fitVideo?t+r:r}}]);return n}(e);export{le as default};

